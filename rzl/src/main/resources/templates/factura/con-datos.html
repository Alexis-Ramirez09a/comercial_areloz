<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es" x-data="facturaConDatos()">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Factura Con Datos | Comercial Areloz</title>

    <link th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" rel="stylesheet" />
    <link th:href="@{/webjars/bootstrap-icons/1.10.5/font/bootstrap-icons.css}" rel="stylesheet" />

    <script defer src="https://unpkg.com/alpinejs@3"></script>

    <style>
        body {
            background: linear-gradient(to bottom right, #eaf6ff, #f4f9ff);
            font-family: 'Segoe UI', sans-serif;
            color: #333;
            min-height: 100vh;
        }

        .invoice-border {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            max-width: 900px;
            margin: 2rem auto;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.05);
        }

        .bar {
            background: #6699cc;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            text-align: center;
        }

        .table-invoice th,
        .table-invoice td {
            border: 1px solid #6699cc;
        }

        .total-line {
            font-weight: bold;
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="invoice-border">
        <div class="bar mb-4">FACTURA – Con Datos</div>

        <!-- Mensaje de error -->
        <div th:if="${error}" class="alert alert-danger mb-3">
            <span th:text="${error}"></span>
        </div>
        <form th:action="@{/factura}" th:object="${factura}" method="post">
            <!-- Oculta la cédula del cliente -->
            <input type="hidden" th:field="*{cliente.cedula}" />

            <!-- (Opcional) También puedes enviar el ID del cliente, que es más fiable -->
            <input type="hidden" th:field="*{cliente.id}" />

            <!-- Fecha -->
            <div class="row mb-4">
                <div class="col-md-6 mb-2">
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                        data-bs-target="#clienteModal">
                        <i class="bi bi-person-plus"></i> Buscar Cliente
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <label class="form-label">Fecha</label>
                    <input type="datetime-local" th:field="*{fecha}" x-model="fecha"
                        class="form-control form-control-sm d-inline-block w-auto" />
                </div>
            </div>

            <!-- Datos del cliente -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div><strong>Cédula:</strong> <span x-text="cliente.cedula || '9999999999'"></span></div>
                    <div><strong>Cliente:</strong> <span
                            x-text="(cliente.nombre && cliente.apellido) ? (cliente.nombre + ' ' + cliente.apellido) : 'Consumidor Final'"></span>
                    </div>
                    <div><strong>Dirección:</strong> <span x-text="cliente.direccion || 'S/D'"></span></div>
                </div>
            </div>

            <!-- Tabla de productos -->
            <div class="table-responsive mb-3">
                <table class="table table-invoice">
                    <thead class="bar">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end">Importe</th>
                            <th class="text-end">Descuento</th>
                            <th class="text-center">×</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(item, idx) in detalles" :key="idx">
                            <tr>
                                <td>
                                    <input type="hidden" :name="`detalles[${idx}].productoId`"
                                        :value="item.productoId" />
                                    <span x-text="item.productoId"></span>
                                </td>
                                <td><span x-text="item.nombre"></span></td>
                                <td><span x-text="item.descripcion"></span></td>
                                <td class="text-center">
                                    <input type="number" min="1" :name="`detalles[${idx}].cantidad`"
                                        x-model.number="item.cantidad" @input="recalcular()"
                                        class="form-control form-control-sm text-center" />
                                </td>
                                <td class="text-end">
                                    <input type="hidden" :name="`detalles[${idx}].precioUnitario`"
                                        :value="item.precioUnitario" />
                                    <span x-text="format(item.precioUnitario)"></span>
                                </td>
                                <td class="text-end"><span x-text="format(item.importe)"></span></td>
                                <td class="text-end">
                                    <input type="hidden" :name="`detalles[${idx}].descuento`" :value="item.descuento" />
                                    <span x-text="format(item.descuento)"></span>
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-danger"
                                        @click="detalles.splice(idx, 1); recalcular()">×</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="detalles.length === 0">
                            <td colspan="8" class="text-center text-muted py-2">No hay productos</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Botón agregar producto -->
            <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                    data-bs-target="#productoModal">
                    <i class="bi bi-box-seam"></i> Agregar Producto
                </button>
            </div>

            <!-- Totales -->
            <div class="row mb-4">
                <div class="col-md-8"></div>
                <div class="col-md-4">
                    <dl class="row mb-0">
                        <dt class="col-6 text-end">SUBTOTAL:</dt>
                        <dd class="col-6 text-end" x-text="format(rawSubtotal)"></dd>
                        <dt class="col-6 text-end">DESCUENTO:</dt>
                        <dd class="col-6 text-end" x-text="format(descuentoTotal)"></dd>
                        <dt class="col-6 text-end">IVA 12%:</dt>
                        <dd class="col-6 text-end" x-text="format(iva)"></dd>
                        <dt class="col-6 text-end total-line">TOTAL:</dt>
                        <dd class="col-6 text-end total-line" x-text="format(total)"></dd>
                    </dl>
                </div>
            </div>

            <!-- Acciones -->
            <div class="d-flex justify-content-between no-print">
                <a th:href="@{/}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Guardar
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL CLIENTE -->
    <div class="modal fade" id="clienteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" x-model="clienteSearch" placeholder="Cédula o nombre"
                        @input.debounce.500="buscarClientes()" class="form-control mb-3" />
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Cédula</th>
                                <th>Nombre Completo</th>
                                <th>Dirección</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="c in clientesResult" :key="c.id">
                                <tr>
                                    <td x-text="c.cedula"></td>
                                    <td x-text="c.nombre + ' ' + c.apellido"></td>
                                    <td x-text="c.direccion"></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary"
                                            @click="seleccionarCliente(c)" data-bs-dismiss="modal">
                                            Seleccionar
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="clientesResult.length === 0">
                                <td colspan="4" class="text-center text-muted">Ningún cliente encontrado</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div class="modal fade" id="productoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" x-model="productoSearch" placeholder="Nombre o código"
                        @input.debounce.500="buscarProductos()" class="form-control mb-3" />
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="p in productosResult" :key="p.id">
                                <tr>
                                    <td x-text="p.id"></td>
                                    <td x-text="p.nombre"></td>
                                    <td x-text="format(p.precio)"></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success" @click="agregarProducto(p)"
                                            data-bs-dismiss="modal">
                                            Agregar
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="productosResult.length === 0">
                                <td colspan="4" class="text-center text-muted">Sin productos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT Alpine y Bootstrap -->
    <script>
        function facturaConDatos() {
            return {
                clienteSearch: '',
                clientesResult: [],
                cliente: { id: null, cedula: '', nombre: '', apellido: '', direccion: '' },

                productoSearch: '',
                productosResult: [],
                detalles: [],
                fecha: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16),

                get rawSubtotal() {
                    return this.detalles.reduce((sum, it) => sum + (it.cantidad * it.precioUnitario), 0);
                },
                get descuentoTotal() {
                    return this.detalles.reduce((sum, it) => sum + (it.descuento || 0), 0);
                },
                get subtotal() {
                    return this.rawSubtotal - this.descuentoTotal;
                },
                get iva() {
                    return this.subtotal * 0.12;
                },
                get total() {
                    return this.subtotal + this.iva;
                },
                format(v) {
                    return (+v || 0).toFixed(2);
                },

                buscarClientes() {
                    fetch(`/api/clientes/search?q=${encodeURIComponent(this.clienteSearch)}`)
                        .then(r => r.json())
                        .then(js => this.clientesResult = js);
                },
                seleccionarCliente(c) {
                    this.cliente = { ...c };
                },

                buscarProductos() {
                    fetch(`/api/productos/search?q=${encodeURIComponent(this.productoSearch)}`)
                        .then(r => r.json())
                        .then(js => this.productosResult = js);
                },
                agregarProducto(p) {
                    this.detalles.push({
                        productoId: p.id,
                        nombre: p.nombre,
                        descripcion: p.descripcion,
                        cantidad: 1,
                        precioUnitario: p.precio,
                        importe: p.precio,
                        descuento: 0
                    });
                    this.recalcular();
                },

                recalcular() {
                    this.detalles.forEach(d => {
                        d.importe = d.cantidad * d.precioUnitario;
                        d.descuento = d.cantidad >= 5 ? d.importe * 0.10 : 0;
                    });
                }
            };
        }
    </script>

    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
</body>

</html>